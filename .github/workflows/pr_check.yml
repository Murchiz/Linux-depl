name: PR Quick Check

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
    paths:
      - 'app/**'
      - 'build.gradle'
      - 'app/build.gradle'
      - 'settings.gradle'
      - 'gradle/**'

concurrency:
  group: pr-${{ github.head_ref }}
  cancel-in-progress: true

env:
  GRADLE_VERSION: '8.7'

jobs:
  quick-build:
    name: Quick Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # â”€â”€ Generate Gradle wrapper if absent â”€â”€
      - name: Check for Gradle wrapper
        id: wrapper-check
        run: |
          if [ -f "gradlew" ] && [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Gradle wrapper found"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  Gradle wrapper NOT found â€” will generate"
          fi

      - name: Install Gradle for wrapper generation
        if: steps.wrapper-check.outputs.exists == 'false'
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: Generate Gradle wrapper
        if: steps.wrapper-check.outputs.exists == 'false'
        run: |
          gradle wrapper --gradle-version "${{ env.GRADLE_VERSION }}" --distribution-type bin
          chmod +x gradlew
          echo "### âš™ï¸ Gradle wrapper generated (v${{ env.GRADLE_VERSION }})" >> "$GITHUB_STEP_SUMMARY"
          echo "Consider committing wrapper files to the repo." >> "$GITHUB_STEP_SUMMARY"

      - name: Ensure gradlew is executable
        run: chmod +x gradlew

      - uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "platforms;android-23"

      - uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Compile Debug
        run: ./gradlew compileDebugSources --stacktrace

      - name: Run Tests
        run: ./gradlew testDebugUnitTest --stacktrace

      - name: Check APK builds
        run: ./gradlew assembleDebug --stacktrace

      - name: Comment APK size
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const apkDir = 'app/build/outputs/apk/debug';
            const files = fs.readdirSync(apkDir).filter(f => f.endsWith('.apk'));
            if (files.length > 0) {
              const stat = fs.statSync(path.join(apkDir, files[0]));
              const sizeMB = (stat.size / (1024 * 1024)).toFixed(2);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸ“¦ **Debug APK:** \`${files[0]}\` â€” **${sizeMB} MB**`
              });
            }
