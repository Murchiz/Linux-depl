name: Android CI/CD

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (debug/release/both)'
        required: false
        default: 'both'
        type: choice
        options:
          - debug
          - release
          - both

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  ANDROID_MIN_SDK: '23'
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true
    -Dorg.gradle.jvmargs=-Xmx4g

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Validation & Lint
  # ──────────────────────────────────────────────
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run Lint
        run: ./gradlew lint --stacktrace

      - name: Upload Lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            app/build/reports/lint-results*.html
            app/build/reports/lint-results*.xml
          retention-days: 14

  # ──────────────────────────────────────────────
  # Job 2: Build Debug APK
  # ──────────────────────────────────────────────
  build-debug:
    name: Build Debug APK
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.build_type == 'debug' ||
      github.event.inputs.build_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Gather APK info
        id: apk-info
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_size=$APK_SIZE" >> "$GITHUB_OUTPUT"
          echo "### Debug APK Built ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** $APK_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Size:** $APK_SIZE" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: error

  # ──────────────────────────────────────────────
  # Job 3: Build Release APK (signed)
  # ──────────────────────────────────────────────
  build-release:
    name: Build Release APK
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      startsWith(github.ref, 'refs/tags/v') ||
      github.event.inputs.build_type == 'release' ||
      github.event.inputs.build_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # ── Decode keystore from secrets ──
      - name: Decode Keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
          echo "KEYSTORE_DECODED=true" >> "$GITHUB_ENV"

      # ── Build with signing config if secrets exist ──
      - name: Build Signed Release APK
        if: env.KEYSTORE_DECODED == 'true'
        env:
          RELEASE_STORE_FILE: release-keystore.jks
          RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --stacktrace

      # ── Fallback: build unsigned release if no secrets ──
      - name: Build Unsigned Release APK
        if: env.KEYSTORE_DECODED != 'true'
        run: |
          echo "⚠️  No signing secrets found – building unsigned APK"
          ./gradlew assembleRelease --stacktrace
          echo "### ⚠️ Unsigned Release" >> "$GITHUB_STEP_SUMMARY"
          echo "Configure repository secrets for signed builds." >> "$GITHUB_STEP_SUMMARY"

      - name: Gather APK info
        id: apk-info
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_size=$APK_SIZE" >> "$GITHUB_OUTPUT"
          echo "### Release APK Built ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** $APK_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Size:** $APK_SIZE" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: error

      - name: Cleanup keystore
        if: always()
        run: rm -f app/release-keystore.jks

  # ──────────────────────────────────────────────
  # Job 4: Unit Tests
  # ──────────────────────────────────────────────
  test:
    name: Unit Tests
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' 
