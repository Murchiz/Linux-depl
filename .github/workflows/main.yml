name: Android CI/CD

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (debug/release/both)'
        required: false
        default: 'both'
        type: choice
        options:
          - debug
          - release
          - both
      gradle_version:
        description: 'Gradle version for wrapper generation (if missing)'
        required: false
        default: '8.7'
        type: string

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  ANDROID_MIN_SDK: '23'
  GRADLE_VERSION: '8.7'
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true
    -Dorg.gradle.jvmargs=-Xmx4g

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Validation & Lint
  # ──────────────────────────────────────────────
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      # ── Generate Gradle wrapper if absent ──
      - name: Check for Gradle wrapper
        id: wrapper-check
        run: |
          if [ -f "gradlew" ] && [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "✅ Gradle wrapper found"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "⚠️  Gradle wrapper NOT found — will generate"
          fi

      - name: Install Gradle for wrapper generation
        if: steps.wrapper-check.outputs.exists == 'false'
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ inputs.gradle_version || env.GRADLE_VERSION }}

      - name: Generate Gradle wrapper
        if: steps.wrapper-check.outputs.exists == 'false'
        run: |
          WRAPPER_VERSION="${{ inputs.gradle_version || env.GRADLE_VERSION }}"
          echo "Generating Gradle wrapper v${WRAPPER_VERSION}..."
          gradle wrapper --gradle-version "$WRAPPER_VERSION" --distribution-type bin
          chmod +x gradlew
          echo "### ⚙️ Gradle Wrapper Generated" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Version:** ${WRAPPER_VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Consider committing \`gradlew\`, \`gradlew.bat\`, and \`gradle/wrapper/\` to the repo." >> "$GITHUB_STEP_SUMMARY"

      - name: Verify Gradle wrapper
        run: |
          echo "Wrapper version:"
          ./gradlew --version

      - name: Validate Gradle wrapper (if pre-existing)
        if: steps.wrapper-check.outputs.exists == 'true'
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run Lint
        run: ./gradlew lint --stacktrace

      - name: Upload Lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            app/build/reports/lint-results*.html
            app/build/reports/lint-results*.xml
          retention-days: 14

      # ── Upload generated wrapper as artifact for other jobs ──
      - name: Upload Gradle wrapper
        if: steps.wrapper-check.outputs.exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: gradle-wrapper
          path: |
            gradlew
            gradlew.bat
            gradle/wrapper/gradle-wrapper.jar
            gradle/wrapper/gradle-wrapper.properties
          retention-days: 1

  # ──────────────────────────────────────────────
  # Job 2: Build Debug APK
  # ──────────────────────────────────────────────
  build-debug:
    name: Build Debug APK
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.build_type == 'debug' ||
      github.event.inputs.build_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      # ── Restore generated wrapper if it was absent in repo ──
      - name: Check for Gradle wrapper
        id: wrapper-check
        run: |
          if [ -f "gradlew" ] && [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download generated Gradle wrapper
        if: steps.wrapper-check.outputs.exists == 'false'
        uses: actions/download-artifact@v4
        with:
          name: gradle-wrapper
        continue-on-error: true

      - name: Generate Gradle wrapper (fallback)
        if: steps.wrapper-check.outputs.exists == 'false' && !hashFiles('gradlew')
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ inputs.gradle_version || env.GRADLE_VERSION }}

      - name: Generate Gradle wrapper (fallback exec)
        if: steps.wrapper-check.outputs.exists == 'false' && !hashFiles('gradlew')
        run: |
          gradle wrapper --gradle-version "${{ inputs.gradle_version || env.GRADLE_VERSION }}" --distribution-type bin

      - name: Ensure gradlew is executable
        run: chmod +x gradlew

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Gather APK info
        id: apk-info
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_size=$APK_SIZE" >> "$GITHUB_OUTPUT"
          echo "### Debug APK Built ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** $APK_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Size:** $APK_SIZE" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: error

  # ──────────────────────────────────────────────
  # Job 3: Build Release APK (signed)
  # ──────────────────────────────────────────────
  build-release:
    name: Build Release APK
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      startsWith(github.ref, 'refs/tags/v') ||
      github.event.inputs.build_type == 'release' ||
      github.event.inputs.build_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      # ── Restore generated wrapper if it was absent in repo ──
      - name: Check for Gradle wrapper
        id: wrapper-check
        run: |
          if [ -f "gradlew" ] && [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download generated Gradle wrapper
        if: steps.wrapper-check.outputs.exists == 'false'
        uses: actions/download-artifact@v4
        with:
          name: gradle-wrapper
        continue-on-error: true

      - name: Generate Gradle wrapper (fallback)
        if: steps.wrapper-check.outputs.exists == 'false' && !hashFiles('gradlew')
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ inputs.gradle_version || env.GRADLE_VERSION }}

      - name: Generate Gradle wrapper (fallback exec)
        if: steps.wrapper-check.outputs.exists == 'false' && !hashFiles('gradlew')
        run: |
          gradle wrapper --gradle-version "${{ inputs.gradle_version || env.GRADLE_VERSION }}" --distribution-type bin

      - name: Ensure gradlew is executable
        run: chmod +x gradlew

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # ── Decode keystore from secrets ──
      - name: Decode Keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
          echo "KEYSTORE_DECODED=true" >> "$GITHUB_ENV"

      # ── Build with signing config if secrets exist ──
      - name: Build Signed Release APK
        if: env.KEYSTORE_DECODED == 'true'
        env:
          RELEASE_STORE_FILE: release-keystore.jks
          RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --stacktrace

      # ── Fallback: build unsigned release if no secrets ──
      - name: Build Unsigned Release APK
        if: env.KEYSTORE_DECODED != 'true'
        run: |
          echo "⚠️  No signing secrets found — building unsigned APK"
          ./gradlew assembleRelease --stacktrace
          echo "### ⚠️ Unsigned Release" >> "$GITHUB_STEP_SUMMARY"
          echo "Configure repository secrets for signed builds." >> "$GITHUB_STEP_SUMMARY"

      - name: Gather APK info
        id: apk-info
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_size=$APK_SIZE" >> "$GITHUB_OUTPUT"
          echo "### Release APK Built ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** $APK_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Size:** $APK_SIZE" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: error

      - name: Cleanup keystore
        if: always()
        run: rm -f app/release-keystore.jks

  # ──────────────────────────────────────────────
  # Job 4: Unit Tests
  # ──────────────────────────────────────────────
  test:
    name: Unit Tests
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      # ── Restore generated wrapper if it was absent in repo ──
      - name: Check for Gradle wrapper
        id: wrapper-check
        run: |
          if [ -f "gradlew" ] && [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download generated Gradle wrapper
        if: steps.wrapper-check.outputs.exists == 'false'
        uses: actions/download-artifact@v4
        with:
          name: gradle-wrapper
        continue-on-error: true

      - name: Generate Gradle wrapper (fallback)
        if: steps.wrapper-check.outputs.exists == 'false' && !hashFiles('gradlew')
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ inputs.gradle_version || env.GRADLE_VERSION }}

      - name: Generate Gradle wrapper (fallback exec)
        if: steps.wrapper-check.outputs.exists == 'false' && !hashFiles('gradlew')
        run: |
          gradle wrapper --gradle-version "${{ inputs.gradle_version || env.GRADLE_VERSION }}" --distribution-type bin

      - name: Ensure gradlew is executable
        run: chmod +x gradlew

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest --stacktrace

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            app/build/reports/tests/
            app/build/test-results/
          retention-days: 14

  # ──────────────────────────────────────────────
  # Job 5: GitHub Release (on tag push)
  # ──────────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [ build-debug, build-release, test ]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: apk-debug
          path: artifacts/debug

      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: apk-release
          path: artifacts/release

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Rename APKs with version
        run: |
          DEBUG_APK=$(find artifacts/debug -name "*.apk" | head -1)
          RELEASE_APK=$(find artifacts/release -name "*.apk" | head -1)
          cp "$DEBUG_APK"   "artifacts/LinuxDeploy-${{ steps.version.outputs.version }}-debug.apk"
          cp "$RELEASE_APK" "artifacts/LinuxDeploy-${{ steps.version.outputs.version }}-release.apk"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -2 | tail -1)
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "## What's Changed"
            echo ""
            echo "$CHANGES"
            echo ""
            echo "### Device Compatibility"
            echo "- Digma Plane 1553m 4G"
            echo "- Sony Xperia F3311 / E5"
            echo "- Any rooted Android 6.0+ (API 23+) device"
            echo ""
            echo "### Requirements"
            echo "- Root access (su) properly configured"
            echo "- ~500 MB free storage for Linux rootfs"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Linux Deploy v${{ steps.version.outputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            artifacts/LinuxDeploy-${{ steps.version.outputs.version }}-debug.apk
            artifacts/LinuxDeploy-${{ steps.version.outputs.version }}-release.apk
          fail_on_unmatched_files: false            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run Lint
        run: ./gradlew lint --stacktrace

      - name: Upload Lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            app/build/reports/lint-results*.html
            app/build/reports/lint-results*.xml
          retention-days: 14

  # ──────────────────────────────────────────────
  # Job 2: Build Debug APK
  # ──────────────────────────────────────────────
  build-debug:
    name: Build Debug APK
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.build_type == 'debug' ||
      github.event.inputs.build_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Gather APK info
        id: apk-info
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_size=$APK_SIZE" >> "$GITHUB_OUTPUT"
          echo "### Debug APK Built ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** $APK_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Size:** $APK_SIZE" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: error

  # ──────────────────────────────────────────────
  # Job 3: Build Release APK (signed)
  # ──────────────────────────────────────────────
  build-release:
    name: Build Release APK
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >-
      startsWith(github.ref, 'refs/tags/v') ||
      github.event.inputs.build_type == 'release' ||
      github.event.inputs.build_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # ── Decode keystore from secrets ──
      - name: Decode Keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
          echo "KEYSTORE_DECODED=true" >> "$GITHUB_ENV"

      # ── Build with signing config if secrets exist ──
      - name: Build Signed Release APK
        if: env.KEYSTORE_DECODED == 'true'
        env:
          RELEASE_STORE_FILE: release-keystore.jks
          RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --stacktrace

      # ── Fallback: build unsigned release if no secrets ──
      - name: Build Unsigned Release APK
        if: env.KEYSTORE_DECODED != 'true'
        run: |
          echo "⚠️  No signing secrets found – building unsigned APK"
          ./gradlew assembleRelease --stacktrace
          echo "### ⚠️ Unsigned Release" >> "$GITHUB_STEP_SUMMARY"
          echo "Configure repository secrets for signed builds." >> "$GITHUB_STEP_SUMMARY"

      - name: Gather APK info
        id: apk-info
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_size=$APK_SIZE" >> "$GITHUB_OUTPUT"
          echo "### Release APK Built ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** $APK_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Size:** $APK_SIZE" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: error

      - name: Cleanup keystore
        if: always()
        run: rm -f app/release-keystore.jks

  # ──────────────────────────────────────────────
  # Job 4: Unit Tests
  # ──────────────────────────────────────────────
  test:
    name: Unit Tests
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK components
        run: |
          sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-${{ env.ANDROID_MIN_SDK }}"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
